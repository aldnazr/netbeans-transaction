
CREATE TABLE brand (
    ID_BRAND INT PRIMARY KEY,
    NAMA_BRAND VARCHAR(100) UNIQUE
);

CREATE TABLE phones (
    ID_PHONE INT PRIMARY KEY,
    ID_BRAND INT,
    NAMA_HANDPHONE VARCHAR(100) UNIQUE,
    DESKRIPSI VARCHAR(255),
    HARGA INT,
    STOK INT
);

CREATE TABLE users (
    ID_USER INT PRIMARY KEY,
    NAMA_LENGKAP VARCHAR(100) NOT NULL,
    GENDER VARCHAR(100) NOT NULL,
    ALAMAT VARCHAR(255),
    EMAIL VARCHAR(100) UNIQUE NOT NULL,
    TIPE_AKUN VARCHAR(10),
    USERNAME VARCHAR(100),
    PASSWORD VARCHAR(100)
);

CREATE TABLE session_data (
    ID_USER INT
);

CREATE TABLE transaksi (
    ID_TRANSAKSI INT PRIMARY KEY,
    ID_USER INT,
    NAMA_PELANGGAN VARCHAR(100),
    TANGGAL TIMESTAMP,
    TOTAL_BAYAR INT
);

CREATE TABLE barang_keluar (
    ID_TRANSAKSI INT,
    ID_PHONE INT,
    JUMLAH_KELUAR INT    
);

//
//  ALTER TABLE FOR FOREIGN KEY
//

ALTER TABLE phones
  ADD FOREIGN KEY (ID_BRAND) REFERENCES brand (ID_BRAND);

ALTER TABLE transaksi
  ADD FOREIGN KEY (ID_USER) REFERENCES users (ID_USER);

ALTER TABLE session_data
  ADD FOREIGN KEY (ID_USER) REFERENCES users (ID_USER);

ALTER TABLE barang_keluar
    ADD FOREIGN KEY (ID_PHONE) REFERENCES phones (ID_PHONE);

ALTER TABLE barang_keluar
    ADD FOREIGN KEY (ID_TRANSAKSI) REFERENCES transaksi (ID_TRANSAKSI);

//
//  SEQUENCE FOR AUTO INCREMENT
//

CREATE SEQUENCE sequence_brand
    START WITH 1
    INCREMENT BY 1
NOMAXVALUE;

CREATE SEQUENCE sequence_phones
    START WITH 1
    INCREMENT BY 1
NOMAXVALUE;

CREATE SEQUENCE sequence_users
    START WITH 1
    INCREMENT BY 1
NOMAXVALUE;

CREATE SEQUENCE sequence_transaksi
    START WITH 1
    INCREMENT BY 1
NOMAXVALUE;


//
//  TRIGGER FOR AUTO INCREMENT
//

CREATE OR REPLACE TRIGGER autoincrement_brand
BEFORE INSERT ON brand
FOR EACH ROW
BEGIN
    SELECT sequence_brand.NEXTVAL
    INTO :new.id_brand
    FROM dual;
END;

CREATE OR REPLACE TRIGGER autoincrement_phones
BEFORE INSERT ON phones
FOR EACH ROW
BEGIN
    SELECT sequence_phones.NEXTVAL
    INTO :new.ID_PHONE
    FROM dual;
END;

CREATE OR REPLACE TRIGGER autoincrement_users
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    SELECT sequence_users.NEXTVAL
    INTO :new.id_user
    FROM dual;
END;

CREATE OR REPLACE TRIGGER autoincrement_transaksi
BEFORE INSERT ON transaksi
FOR EACH ROW
BEGIN
    SELECT sequence_transaksi.NEXTVAL
    INTO :new.id_transaksi
    FROM dual;
END;

//
//  Function
//

CREATE OR REPLACE FUNCTION getMaxTransaksiId return int
IS
    maxid int;
BEGIN
    SELECT MAX(ID_TRANSAKSI) 
    INTO maxid 
    FROM TRANSAKSI;
    
    return maxid;
END;

COMMIT;

SELECT getMaxTransaksiId AS "Max ID Transaksi" from dual;

DROP SEQUENCE SEQUENCE_BRAND;
DROP SEQUENCE SEQUENCE_PHONES;
DROP SEQUENCE SEQUENCE_USERS;
DROP SEQUENCE SEQUENCE_TRANSAKSI;

DROP TABLE BRAND;
DROP TABLE PHONES;
DROP TABLE USERS;
DROP TABLE TRANSAKSI;
DROP TABLE SESSION_DATA;
DROP TABLE BARANG_KELUAR;

SELECT * FROM BRAND;
SELECT * FROM PHONES;
SELECT * FROM USERS;
SELECT * FROM SESSION_DATA;
SELECT * FROM TRANSAKSI;
SELECT * FROM BARANG_KELUAR;

DELETE FROM SESSION_DATA;
DELETE FROM TRANSAKSI;
DELETE FROM BARANG_KELUAR;

INSERT INTO users (NAMA_LENGKAP, GENDER, ALAMAT, EMAIL, TIPE_AKUN, USERNAME, PASSWORD) VALUES (
    'Admin',
    'Laki-laki',
    'Rungkut, Surabaya',
    'admin@gmail.com',
    'Admin',
    'admin',
    'admin'
);

INSERT INTO BRAND (NAMA_BRAND)VALUES ('Samsung');
INSERT INTO BRAND (NAMA_BRAND)VALUES ('Xiaomi');
INSERT INTO BRAND (NAMA_BRAND)VALUES ('Sony');
INSERT INTO BRAND (NAMA_BRAND)VALUES ('Apple');
INSERT INTO BRAND (NAMA_BRAND)VALUES ('Oppo');
INSERT INTO BRAND (NAMA_BRAND)VALUES ('Vivo');

INSERT INTO PHONES (ID_BRAND, NAMA_HANDPHONE, HARGA, STOK) VALUES ('1', 'S23', '10000', '10');
INSERT INTO PHONES (ID_BRAND, NAMA_HANDPHONE, HARGA, STOK) VALUES ('2', 'POCO X5', '20000', '8');
INSERT INTO PHONES (ID_BRAND, NAMA_HANDPHONE, HARGA, STOK) VALUES ('3', 'Xperia 5', '30000', '14');

INSERT INTO TRANSAKSI (ID_USER, NAMA_PELANGGAN, TANGGAL, TOTAL_BAYAR) VALUES ('1', 'Ahmad', TO_TIMESTAMP('02/11/2023 00:03'), '1000');
INSERT INTO barang_keluar VALUES ('1', '1', '100');
INSERT INTO barang_keluar VALUES ('1', '3', '100');
INSERT INTO barang_keluar VALUES ('1', '4', '100');
INSERT INTO barang_keluar VALUES ('1', '3', '100');

